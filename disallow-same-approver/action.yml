name: disallow-same-approver
description: Do not allow the person who initiated the deployment to approve it.

runs:

  using: composite

  steps:

    - name: Do not allow the person who initiated the deployment to approve it
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
      with:
        script: |

          const approvals = await github.request('GET /repos/{owner}/{repo}/actions/runs/{run_id}/approvals', {
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId
          })

          const latestApproval = approvals.data[0];

          if (latestApproval.user.login == context.actor){
            core.setFailed(`The person who started the deployment (${context.actor}) is not allowed to approve it.`);
            return;
          }
