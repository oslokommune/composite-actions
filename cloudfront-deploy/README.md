# CloudFront Deploy Action

A GitHub Actions composite action for deploying pre-built static sites to S3 and CloudFront.

## Description

This action automates the deployment process for static websites by:

1. Configuring AWS credentials using OIDC
2. Automatically discovering the CloudFront distribution ID
3. Syncing files to an S3 bucket
4. Creating CloudFront cache invalidations

## Usage

```yaml
- name: Build static site
  run: |
    # Your build process here
    # e.g., npm run build, hugo build, etc.
    npm run build

- name: Deploy to CloudFront
  uses: oslokommune/golden-path-boilerplate@main
  with:
    aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
    s3-bucket-name: ${{ secrets.S3_BUCKET_NAME }}
    site-path: './dist'  # or wherever your built files are
```

## Requirements

### Pre-built Static Files

Your static site files must be built before using this action. The action expects to find the built files in the directory specified by the `site-path` input.

### CloudFront Distribution

The action automatically discovers the CloudFront distribution by finding a distribution with:
- An origin with ID `s3_origin`
- An origin domain name that starts with `{bucket-name}.s3.`

## Example Workflow

```yaml
name: Deploy to CloudFront

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build static site
        run: npm run build

      - name: Deploy to CloudFront
        uses: oslokommune/golden-path-boilerplate@main
        with:
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
          s3-bucket-name: ${{ secrets.S3_BUCKET_NAME }}
          site-path: './dist'
```

## Security Considerations

- Always use GitHub environments for production deployments
- Store sensitive values like `aws-role-arn` and `s3-bucket-name` as environment secrets
- The action requires `id-token: write` permission for OIDC authentication
- Consider using least-privilege IAM policies

## Troubleshooting

**Multiple CloudFront distributions found:**
Ensure only one CloudFront distribution has an origin with ID `s3_origin` that targets your S3 bucket.

**Permission denied errors:**
Check that your IAM role has the required S3 and CloudFront permissions listed above.

**Files not found:**
Ensure your build process outputs files to the directory specified in the `site-path` input.

<!-- BOILERPLATE BEGIN -->
<!-- Generated by running `make docs` from the project root -->

# CloudFront Deploy

Deploy pre-built static sites to S3 and CloudFront

**Author:** oslokommune

## Usage

### Inputs

|     Input      |                    Description                     |Required|   Default   |
|----------------|----------------------------------------------------|--------|-------------|
|`aws-role-arn`  |AWS IAM role ARN for OIDC authentication            |yes     |``n/a``      |
|`aws-region`    |AWS region                                          |no      |``eu-west-1``|
|`s3-bucket-name`|Target S3 bucket name for deployment                |yes     |``n/a``      |
|`site-path`     |Path to directory containing built static site files|no      |``./site``   |

### Example

```yaml
- name: CloudFront Deploy
  uses: oslokommune/composite-actions/cloudfront-deploy@main
  with:
    aws-role-arn: # Required
    # aws-region: # Optional, default: eu-west-1
    s3-bucket-name: # Required
    # site-path: # Optional, default: ./site
```

## Branding

- **Icon:** cloud
- **Color:** blue



<!-- BOILERPLATE END -->
